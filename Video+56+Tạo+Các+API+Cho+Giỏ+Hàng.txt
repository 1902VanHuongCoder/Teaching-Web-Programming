# üõí M√¥ ph·ªèng m·ªëi quan h·ªá gi·ªØa GioHang, ChiTietGioHang, v√† Sach Models

## üìã T·ªïng quan c√°c Models

### üè™ Model GioHang (Shopping Cart)
- gioHangID (Primary Key)
- nguoiDungID (Foreign Key ‚Üí NguoiDung)
- ngayTao
- createdAt, updatedAt

### üì¶ Model ChiTietGioHang (Cart Items - B·∫£ng trung gian)
- chiTietGioHangID (Primary Key)
- gioHangID (Foreign Key ‚Üí GioHang)
- sachID (Foreign Key ‚Üí Sach)
- soLuong
- giaLucThem
- tongGia
- createdAt, updatedAt

### üìö Model Sach (Book)
- sachID (Primary Key)
- tenSach
- images
- giaGiam
- soLuong
- ...

---

## üîó M·ªëi quan h·ªá gi·ªØa c√°c Models

```
NguoiDung (1) ‚Üê‚Üí (1) GioHang ‚Üê‚Üí (n) ChiTietGioHang ‚Üê‚Üí (1) Sach (n)
    |                    |                  |                    |
    |                    |                  |                    |
User ID: 123        Cart ID: 1       Cart Item ID: 1      Book ID: 101
                                     Cart Item ID: 2      Book ID: 102
                                     Cart Item ID: 3      Book ID: 103
```

### Gi·∫£i th√≠ch quan h·ªá:
- **NguoiDung ‚Üî GioHang**: 1-1 (M·ªôt ng∆∞·ªùi d√πng c√≥ m·ªôt gi·ªè h√†ng)
- **GioHang ‚Üî ChiTietGioHang**: 1-n (M·ªôt gi·ªè h√†ng c√≥ nhi·ªÅu items - m·ª•c)
- **Sach ‚Üî ChiTietGioHang**: 1-n (M·ªôt s√°ch c√≥ th·ªÉ trong nhi·ªÅu gi·ªè h√†ng kh√°c nhau)
- **GioHang ‚Üî Sach**: n-n (Many-to-Many th√¥ng qua ChiTietGioHang)

---

## üíæ D·ªØ li·ªáu m·∫´u

### B·∫£ng NguoiDung
```
nguoiDungID | tenNguoiDung | email
------------|--------------|----------------
123         | Nguy·ªÖn A     | a@gmail.com
124         | Tr·∫ßn B       | b@gmail.com
```

### B·∫£ng GioHang
```
gioHangID | nguoiDungID | ngayTao
----------|-------------|------------------
1         | 123         | 2024-09-29 10:00
2         | 124         | 2024-09-29 11:00
```

### B·∫£ng Sach
```
sachID | tenSach              | giaGiam | soLuong
-------|---------------------|---------|--------
101    | Th·∫ßn ƒê·ªìng ƒê·∫•t Nam   | 50000   | 10
102    | Ng√¥n T√¨nh           | 35000   | 8
103    | Phi√™u L∆∞u K·ª≥ Th√∫    | 45000   | 15
104    | S√°ch K·ªπ NƒÉng       | 80000   | 5
```

### B·∫£ng ChiTietGioHang
```
chiTietGioHangID | gioHangID | sachID | soLuong | giaLucThem | tongGia
-----------------|-----------|--------|---------|------------|--------
1                | 1         | 101    | 2       | 50000      | 100000
2                | 1         | 102    | 1       | 35000      | 35000
3                | 1         | 103    | 3       | 45000      | 135000
4                | 2         | 101    | 1       | 50000      | 50000
5                | 2         | 104    | 2       | 80000      | 160000
```

---

## üéØ K·ªãch b·∫£n s·ª≠ d·ª•ng

### K·ªãch b·∫£n 1: Ng∆∞·ªùi d√πng 123 c√≥ gi·ªè h√†ng v·ªõi 3 lo·∫°i s√°ch
```
Ng∆∞·ªùi d√πng: Nguy·ªÖn A (ID: 123)
Gi·ªè h√†ng: ID = 1
‚îú‚îÄ‚îÄ Item 1: Th·∫ßn ƒê·ªìng ƒê·∫•t Nam √ó 2 cu·ªën = 100,000 VNƒê
‚îú‚îÄ‚îÄ Item 2: Ng√¥n T√¨nh √ó 1 cu·ªën = 35,000 VNƒê
‚îî‚îÄ‚îÄ Item 3: Phi√™u L∆∞u K·ª≥ Th√∫ √ó 3 cu·ªën = 135,000 VNƒê
T·ªîNG CONG: 270,000 VNƒê
```

### K·ªãch b·∫£n 2: Ng∆∞·ªùi d√πng 124 c√≥ gi·ªè h√†ng v·ªõi 2 lo·∫°i s√°ch
```
Ng∆∞·ªùi d√πng: Tr·∫ßn B (ID: 124)
Gi·ªè h√†ng: ID = 2
‚îú‚îÄ‚îÄ Item 1: Th·∫ßn ƒê·ªìng ƒê·∫•t Nam √ó 1 cu·ªën = 50,000 VNƒê
‚îî‚îÄ‚îÄ Item 2: S√°ch K·ªπ NƒÉng √ó 2 cu·ªën = 160,000 VNƒê
T·ªîNG CONG: 210,000 VNƒê
```

---

## üìä Truy v·∫•n SQL t∆∞∆°ng ·ª©ng

### 1. L·∫•y gi·ªè h√†ng c·ªßa ng∆∞·ªùi d√πng 123
```sql
SELECT 
    gh.gioHangID,
    gh.nguoiDungID,
    gh.ngayTao,
    ctgh.chiTietGioHangID,
    ctgh.soLuong,
    ctgh.giaLucThem,
    ctgh.tongGia,
    s.sachID,
    s.tenSach,
    s.images,
    s.giaGiam,
    s.soLuong AS soLuongTonKho
FROM giohang gh
LEFT JOIN chitietgiohang ctgh ON gh.gioHangID = ctgh.gioHangID
LEFT JOIN sach s ON ctgh.sachID = s.sachID
WHERE gh.nguoiDungID = 123;
```

### 2. Th√™m s√°ch m·ªõi v√†o gi·ªè h√†ng
```sql
-- B∆∞·ªõc 1: Ki·ªÉm tra gi·ªè h√†ng t·ªìn t·∫°i
SELECT * FROM giohang WHERE nguoiDungID = 123;

-- B∆∞·ªõc 2: Th√™m item m·ªõi
INSERT INTO chitietgiohang (gioHangID, sachID, soLuong, giaLucThem, tongGia)
VALUES (1, 104, 1, 80000, 80000);
```

### 3. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
```sql
UPDATE chitietgiohang 
SET soLuong = 5, tongGia = soLuong * giaLucThem
WHERE chiTietGioHangID = 1;
```

### 4. X√≥a item kh·ªèi gi·ªè h√†ng
```sql
DELETE FROM chitietgiohang WHERE chiTietGioHangID = 2;
```

---

## üîÑ Sequelize Include Query

### L·∫•y gi·ªè h√†ng k√®m chi ti·∫øt
```javascript
const gioHang = await GioHang.findOne({
    where: { nguoiDungID: 123 },
    include: [{
        model: ChiTietGioHang,
        include: [{
            model: Sach,
            attributes: ['sachID', 'tenSach', 'images', 'giaGiam', 'soLuong']
        }]
    }]
});
```

### K·∫øt qu·∫£ JSON
```json
{
    "gioHangID": 1,
    "nguoiDungID": 123,
    "ngayTao": "2024-09-29T10:00:00.000Z",
    "ChiTietGioHangs": [
        {
            "chiTietGioHangID": 1,
            "soLuong": 2,
            "giaLucThem": 50000,
            "tongGia": 100000,
            "Sach": {
                "sachID": 101,
                "tenSach": "Th·∫ßn ƒê·ªìng ƒê·∫•t Nam",
                "images": "[...]",
                "giaGiam": 50000,
                "soLuong": 10
            }
        },
        {
            "chiTietGioHangID": 2,
            "soLuong": 1,
            "giaLucThem": 35000,
            "tongGia": 35000,
            "Sach": {
                "sachID": 102,
                "tenSach": "Ng√¥n T√¨nh",
                "images": "[...]",
                "giaGiam": 35000,
                "soLuong": 8
            }
        }
    ]
}
```

---

## üéØ C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng

### ‚úÖ Th√™m s·∫£n ph·∫©m v√†o gi·ªè
1. Ki·ªÉm tra s√°ch t·ªìn t·∫°i
2. Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho
3. T√¨m/t·∫°o gi·ªè h√†ng
4. Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè ch∆∞a
5. Th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng

### ‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
1. T√¨m chi ti·∫øt gi·ªè h√†ng
2. Ki·ªÉm tra s·ªë l∆∞·ª£ng m·ªõi h·ª£p l·ªá
3. Ki·ªÉm tra t·ªìn kho
4. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng v√† t·ªïng gi√°

### ‚úÖ X√≥a s·∫£n ph·∫©m
1. T√¨m chi ti·∫øt gi·ªè h√†ng
2. X√≥a record

### ‚úÖ L·∫•y th√¥ng tin gi·ªè h√†ng
1. Join 3 b·∫£ng: GioHang + ChiTietGioHang + Sach
2. T√≠nh t·ªïng ti·ªÅn
3. Tr·∫£ v·ªÅ d·ªØ li·ªáu c√≥ c·∫•u tr√∫c

---

## üí° L∆∞u √Ω quan tr·ªçng

- **giaLucThem**: L∆∞u gi√° t·∫°i th·ªùi ƒëi·ªÉm th√™m v√†o gi·ªè (kh√¥ng thay ƒë·ªïi khi gi√° s√°ch thay ƒë·ªïi)
- **tongGia**: Lu√¥n = soLuong √ó giaLucThem
- **Validation**: Lu√¥n ki·ªÉm tra t·ªìn kho tr∆∞·ªõc khi th√™m/c·∫≠p nh·∫≠t
- **Performance**: S·ª≠ d·ª•ng include ƒë·ªÉ gi·∫£m s·ªë query
- **Consistency**: S·ª≠ d·ª•ng transaction khi c·∫ßn thi·∫øt
